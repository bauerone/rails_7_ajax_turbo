# README

Пример приложения на Rails 7 с реализацией асинхронной обработки формы при помощи Turbo.

## Шаги выполнения

1. Создание проекта

	Для того чтобы создать проект была выполнена команда:

	 ```console
	 rails new calculator -T
	 ```

	Опция ```-T``` была передана для того, чтобы генератор приложения не создавал проект с инструментами тестирования по умолчанию. В этом примере будет использоваться RSpec.

2. Установка RSpec

	Для того чтобы использовать фреймворк тестирования RSpec необходимо выполнить следующие шаги:

	* Добавить новую зависомость в Gemfile

		В группу :development, :test добавить следующую строку:
		
		```ruby
		gem 'rspec-rails', '~> 6.0', '>= 6.0.1'
		```

	* После этого необходимо установить новую зависимость в проект с помощью команды:
		```console
		bundle install
		```

	* Следующим шагом является интеграция RSpec в проект с помощью команды:
		```console
		rails g rspec:install
		```

	После выполнениях вышеперечисленных шагов будет создана директория specs с конфигурационными файлами `spec_helper.rb` и `rails_helper.rb`, а также некоторые системные файлы. С этой точки rails-генераторы будут создавать именно rspec-тесты вместе с контроллерами, моделями и представлениями.

3. Создание контроллера

	На этом шаге можно приступить к реализации логики проекта. На этом шаге необходимо создать контроллер для калькулятора. Изначально мы закладываем следующий сценарий:

	```mermaid
	sequenceDiagram
    actor user as Пользователь
    participant app as Приложение
		user->>+app: Запрос страницы для ввода данных
		app-->>-user: Отображение страницы для ввода
    user->>+app: Ввод данных в форму и отправка на обработку
		app-->>-user: Обработка данных и демонстрация пользователю
	```

	На диаграмме последовательностей видно, что приложение должно обработать два разных действия: отображение страницы ввода и обработка данных с выводом пользователю. Из этого можно сделать вывод, что нужно создать контроллер, который будет обеспечивать эти два действия.

	Для этого необходимо выполнить следующую команду:
	
	```console
	rails g controller Calculator input show
	```

	Аргументы вышеприведенной команды следующее:
	* `rails g controller` - создать контроллер.
	* `Calculator` - назвать контроллер "Calculator".
		
		Он будет создан в директории `app/controllers` с именем файла `calculator_controller.rb`.
		
		Также будет создан вспомогательный модуль `calculator_helper.rb` в директории `app/helpers`.
	* `input show` - создать два экшна `input` и `show`.
		
		Вместе с двумя методами в самом контроллере будут созданы два представления `index.html.erb` и `show.html.erb` в папке `app/views/calculator`.
		
		ВНИМАНИЕ!!! По умолчанию эти аргументы также создадут два маршрута в файле `routes.rb`, использующие HTTP-метод GET.

	Поскольку в предыдущем шаге был настроен RSpec - автоматически будут созданы соответствующие файлы тестов в директории `specs`.

4. Настройка маршрутов

	 После создания контроллера рекомендуется сразу настроить маршруты в файле `routes.rb`

	* Установка корневой страницы
		
		Рекомендуется сразу установить корневую страницу, которая будет отображаться при переходе на хост приложения (`/`)

		Для текущего примера в такой роли можно использовать страницу ввода данных. Необходимо явно назначить такой маршрут:
		
		```ruby
		root 'calculator#input'
		```

	* Переназначение машрута для вывода результата

		По умолчанию подтверждение веб-форм использует HTTP-метод POST для отправки данных. На странице input будет находиться именна такая форма, которая будет отправлять введенные пользователем данные. Поэтому необходимо подготовить соответствующий маршрут, который будет ожидать запрос через метод POST:

		```ruby
		post '/сalculator/result'
		```

		Иногда маршруты могут становиться очень длинными и с ними не удобно работать. В таком случае машруты можно переименовать.

		Переименовать маршрут вывода результата для cтраницы вывода можно так:
		
		```ruby
		post '/result', to: 'calculator#result'
		```

		Пример выше можно интерпретировать так: в случае входящего POST-запроса по адресу `/result` перейти в контролер с именем `Calculator` и вызвать метод `result`.

		ПРИМЕЧАНИЕ:

		Получившиеся маршруты можно посмотреть с помощью команды `rails routes`. Данная команда выведет все имеющиеся маршруты в проекте.

		Можно подробно вывести машруты для конкретного контроллера (например для Calculator):

		```console
		rails routes -c calculator --expanded
		```

5. Создание формы калькулятора

	Так как в предыдущем пункте экшн `input` контроллера `Calculator` был установлен в виде стартового по умолчанию, то верстку формы калькулятора следует поместить в шаблон `input.html.erb`, который находится в директории `app/views/calculator`.

	В процессе верстки использовались вспомогательные методы Rails:
	* `form_with` - метод создания формы
	* `label` - текстовая метка
	* `number_field` - поле для ввода чисел
	* `radio_button` - кнопка-переключатель
	* `submit` - кнопка подтверждения формы

	Содержимое `input.html.erb`:
	```
	<h1>Калькулятор</h1>

	<h3>Введите значения и выберите математическую операцию</h3>

	<%= form_with url: result_path do |form| %>
	  <%= form.label('Значение x:') %>
	  <%= form.number_field(:x) %><br/>
	  <%= form.label('Значение y:') %>
	  <%= form.number_field(:y) %><br/>

	  <table>
	    <% ['+', '-', '*', '/'].each do |operation| %>
		  <tr>
			<td><%= form.label(operation) %></td>
			<td><%= form.radio_button(:operation, operation, id: "operation_#{operation}") %></td>
		  </tr>
		<% end %>
	  </table>

	  <%= form.submit('Посчитать', id: 'calculate-btn') %>
	<% end %>
	```


	ПРИМЕЧАНИЕ:

	Веб-формы по умолчанию используюет метод пост, поэтому запись `form_with url: result_path` приведет к созданию html-кода следующего вида:

	```html
	<form action="/result" accept-charset="UTF-8" method="post">
	```

	Для понимания принципов преобразования Rails-шаблонов в HTML рекомендуется посмотреть итоговую разметку в браузере.

6. Обработка полученных данных из формы в контроллере (без валидаций)

	Созданная на шаге 5 форма делает POST-запрос в путь `/result`. Этот маршрут ведет в метод `result` контроллера `Calculator`. Это было прописано в файле `routes.rb` на шаге 4: `post '/result', to: 'calculator#result'`.

	В форме располагаются три поля ввода:
	* `number_field(:x)` - означает, что форма отправит на сервер параметр `x = значение поля`
	* `number_field(:y)` - означает, что форма отправит на сервер параметр `y = значение поля`
	* `radio_button(:operation)` - означает, что форма отправит на сервер параметр `operation = значение выбранного переключателя`

	Таким образом можно сделать вывод, что в метод `result` будут отправлены три параметра: `x`, `y` и `operation`.
	Чтобы получить к ним доступ в контроллере, надо вызвать метод `params`.

	Например, если необходимо получить значение, которые было введено в поле `x`:
	```ruby
	@x_value = params[:x]
	```

	Содержимое params по сути является хешом, где все ключи являются именами аргументов в символьной записи (например значение параметра `'operation'` можно получить так: `params[:operation]`)

	В текущем примере метод `result` должен получать значения `x` и `y`, а потом выполнять над ними математическую операцию (`operation`).

	Для этого метод `result` контроллера `Сalculator` нужно доработать следующим образом:

	```ruby
	def result
      x_value = params[:x].to_f # достаем значение x и приводим его к числу
      y_value = params[:y].to_f # достаем значение y и приводим его к числу
      @result = x_value.send(params[:operation], y_value) # считаем результат
  	end
	```

	Сначала входящие параметры `x` и `y` надо привести к числовому типу (по умолчанию все параметры всегда приходят в виде строк).
	После этого можно посчитать результат с помощью метода `send`.
	
	Данный метод позволяет вызвать функцию от объекта, передав ее в виде строки:

	```ruby
	'hello'.upcase # => 'HELLO'
	'hello'.send('upcase') # => 'HELLO'

	2 + 3 #=> 5
	2.send('+', 3) # => 5
	```

	Результат рассчета записывается в переменную контекста `@result`, которая будет доступна в представлениях (шаблонах).
	
